# 智能抢购助手 v2.0

一个功能强大的自动抢购工具，采用模块化架构设计，支持图形界面和命令行两种模式，具备智能倒计时识别、配置管理、日志记录等功能。

## 功能特点

### 🚀 核心功能
- **智能倒计时识别**：支持多种倒计时格式（HH:MM:SS、MM分SS秒、SS秒）
- **毫秒级精准点击**：倒计时结束后立即执行购买操作
- **图像预处理**：增强对比度，提高OCR识别准确率
- **错误重试机制**：连续识别失败时自动重试

### 🎨 用户界面
- **图形界面模式**：直观的GUI界面，易于配置和操作
- **命令行模式**：适合高级用户和自动化场景
- **实时状态显示**：监控过程可视化

### ⚙️ 配置管理
- **JSON配置文件**：支持保存和加载配置
- **可视化配置**：通过界面直接设置参数
- **鼠标位置获取**：辅助工具帮助确定点击坐标

### 📝 日志系统
- **详细日志记录**：记录所有操作和错误信息
- **文件和控制台输出**：双重日志保障
- **时间戳标记**：精确记录操作时间

## 安装说明

### 1. 环境要求
- Python 3.7+
- macOS/Windows/Linux

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 安装Tesseract OCR

**macOS:**
```bash
brew install tesseract
```

**Windows:**
1. 下载安装包：https://github.com/UB-Mannheim/tesseract/wiki
2. 安装后在配置中设置tesseract路径

**Ubuntu/Debian:**
```bash
sudo apt-get install tesseract-ocr
```

## 项目结构

```
smart_buyer/
├── __init__.py          # 主包入口
├── main.py             # 主入口点
├── core/               # 核心功能模块
│   ├── __init__.py
│   ├── exceptions.py   # 异常定义
│   ├── ocr.py         # OCR处理
│   └── automation.py  # 自动化引擎
├── config/            # 配置管理
│   ├── __init__.py
│   ├── defaults.py    # 默认配置
│   ├── validator.py   # 配置验证
│   └── manager.py     # 配置管理器
├── ui/                # 用户界面
│   ├── __init__.py
│   ├── gui.py         # 图形界面
│   └── cli.py         # 命令行界面
└── utils/             # 工具模块
    ├── __init__.py
    ├── logging.py     # 日志配置
    └── helpers.py     # 辅助函数
```

## 使用方法

### 图形界面模式（推荐）
```bash
# 使用新的模块化版本
python -m smart_buyer

# 或使用向后兼容的方式
python sjz_new.py
```

### 命令行模式
```bash
# 控制台监控模式
python -m smart_buyer --console

# 测试OCR识别
python -m smart_buyer --test-ocr

# 测试按钮点击
python -m smart_buyer --test-click

# 验证配置
python -m smart_buyer --validate-config
```

## 配置说明

### 主要配置项

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| countdown_box | 倒计时区域坐标 (左,上,右,下) | [100, 200, 300, 240] |
| buy_btn_pos | 购买按钮位置 (x,y) | [500, 600] |
| confirm_btn_pos | 确认按钮位置 (x,y) | [550, 650] |
| check_interval | 检查间隔(秒) | 0.1 |
| click_delay | 点击延迟(秒) | 0.05 |
| max_retries | 最大重试次数 | 3 |

### 获取坐标的方法

1. **使用内置工具**：点击"获取鼠标位置"按钮
2. **使用pyautogui**：
   ```python
   import pyautogui
   pyautogui.displayMousePosition()
   ```
3. **手动测量**：使用截图工具测量像素坐标

## 使用步骤

### 图形界面模式

1. **启动程序**
   ```bash
   python sjz.py
   ```

2. **配置参数**
   - 设置倒计时区域坐标
   - 设置购买和确认按钮位置
   - 调整检查间隔等参数

3. **测试配置**
   - 点击"测试倒计时识别"验证设置
   - 使用"获取鼠标位置"确定坐标

4. **保存配置**
   - 点击"保存配置"保存当前设置

5. **开始监控**
   - 点击"开始监控"启动自动抢购
   - 观察状态信息了解运行情况

### 命令行模式

1. **编辑配置文件**（可选）
   ```json
   {
     "countdown_box": [100, 200, 300, 240],
     "buy_btn_pos": [500, 600],
     "confirm_btn_pos": [550, 650],
     "check_interval": 0.1
   }
   ```

2. **运行程序**
   ```bash
   python sjz.py --console
   ```

## 高级功能

### 多种倒计时格式支持
- `HH:MM:SS` 格式：如 "01:30:45"
- `MM分SS秒` 格式：如 "30分45秒"
- `SS秒` 格式：如 "45秒"

### 图像预处理优化
- 自动灰度转换
- 对比度增强
- OCR参数优化

### 安全特性
- 连续识别失败保护
- 异常处理和恢复
- 操作日志记录

## 故障排除

### 常见问题

**Q: 倒计时识别失败**
A: 
- 检查倒计时区域坐标是否正确
- 确保倒计时文字清晰可见
- 尝试调整图像预处理参数

**Q: 点击位置不准确**
A:
- 重新获取按钮坐标
- 考虑屏幕分辨率和缩放设置
- 测试点击位置是否正确

**Q: Tesseract未找到**
A:
- 确保已正确安装Tesseract
- 在配置中设置正确的tesseract路径
- 检查PATH环境变量

### 调试模式

启用详细日志：
```python
logging.getLogger().setLevel(logging.DEBUG)
```

## 注意事项

⚠️ **重要提醒**
- 请遵守相关网站的使用条款
- 合理使用，避免对服务器造成过大压力
- 建议在测试环境中先验证配置
- 使用前请备份重要数据

## 技术支持

如遇到问题，请检查：
1. 日志文件 `抢购日志.log`
2. 配置文件 `config.json`
3. 依赖包是否正确安装

## 新版本特性 (v2.0)

### 🏗️ 模块化架构
- **核心分离**: OCR处理、自动化引擎、配置管理完全分离
- **可扩展性**: 易于添加新功能和自定义组件
- **可测试性**: 每个模块都有对应的单元测试

### 🔧 增强的配置管理
- **配置验证**: 自动验证配置值的有效性
- **类型安全**: 强类型配置管理，减少错误
- **灵活配置**: 支持运行时配置修改

### 🖥️ 改进的用户界面
- **GUI增强**: 更直观的图形界面，实时状态显示
- **CLI功能**: 完整的命令行界面，支持批处理和自动化
- **向后兼容**: 保持与原版本的完全兼容

### 🧪 全面测试覆盖
- **单元测试**: 每个模块都有完整的测试覆盖
- **集成测试**: 验证模块间的协作
- **配置测试**: 确保配置系统的可靠性

## 更新日志

### v2.0.0 (当前版本)
- 🏗️ **重大重构**: 采用模块化架构设计
- ✨ **新增功能**: 完整的CLI界面和参数支持
- 🔧 **配置增强**: 配置验证和类型安全
- 🧪 **测试覆盖**: 全面的单元测试和集成测试
- 📚 **文档完善**: 中文注释和详细文档
- 🔄 **向后兼容**: 保持与v1.0的完全兼容

### v1.0.0
- ✨ 新增图形界面
- ✨ 配置文件支持
- ✨ 日志系统
- ✨ 多种倒计时格式
- ✨ 错误处理和重试
- ✨ 图像预处理优化
- ✨ 鼠标位置获取工具
- 基础倒计时识别和自动点击功能